<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - InsurEdge</title>
    <link rel="stylesheet" href="css/style.css">
    <!-- Add Web3.js and Ethers.js -->
    <script src="https://cdn.jsdelivr.net/npm/web3@1.5.2/dist/web3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.2.0/ethers.umd.min.js"></script>
    <style>
        /* Navigation */
        nav {
            padding: 1rem 5%;
            height: auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
            position: fixed;
            width: 100%;
            top: 0;
            z-index: 1000;
            border-bottom: 1px solid rgba(30, 58, 138, 0.1);
            max-width: 100%;
            box-sizing: border-box;
        }

        .logo {
            flex-shrink: 0;
            margin-right: 2rem;
        }

        .logo img {
            height: 40px;
            width: auto;
        }

        .nav-links {
            display: flex;
            align-items: center;
            gap: 2rem;
            margin-right: auto;
            margin-left: 0;
            flex-grow: 1;
            justify-content: center;
        }

        .nav-links a {
            text-decoration: none;
            color: #333;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.3s ease;
            position: relative;
            padding: 0.5rem 0;
        }

        .nav-links a::after {
            content: '';
            position: absolute;
            width: 0;
            height: 2px;
            bottom: 0;
            left: 50%;
            background: linear-gradient(90deg, #1e3a8a, #2563eb);
            transition: all 0.3s ease;
            transform: translateX(-50%);
        }

        .nav-links a:hover::after {
            width: 100%;
        }

        .flex.items-center.space-x-4 {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-left: auto;
            flex-shrink: 0;
        }

        .wallet-section {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: #f8fafc;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            white-space: nowrap;
        }

        .wallet-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .wallet-btn:hover {
            background: #45a049;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .wallet-btn.connected {
            background: #f44336;
        }

        .wallet-btn.connected:hover {
            background: #d32f2f;
        }

        .wallet-address {
            font-size: 14px;
            color: #666;
            display: none;
            background: #e3f2fd;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .wallet-status {
            font-size: 14px;
            color: #666;
            display: inline-block;
        }

        .wallet-status::before {
            content: "â€¢";
            margin-right: 4px;
            font-size: 16px;
        }

        .wallet-btn.loading {
            position: relative;
            pointer-events: none;
        }

        .wallet-btn.loading::after {
            content: "";
            position: absolute;
            width: 16px;
            height: 16px;
            top: 50%;
            left: 50%;
            margin: -8px 0 0 -8px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .kyc-verified-badge {
            display: inline-flex;
            align-items: center;
            padding: 1px 4px;
            background-color: #4CAF50;
            color: white;
            border-radius: 2px;
            font-size: 0.65rem;
            margin-left: 6px;
            font-weight: 500;
            position: relative;
            line-height: 1;
            height: 16px;
        }

        .kyc-verified-badge.hidden {
            display: none;
        }

        .kyc-status {
            display: flex;
            align-items: center;
            gap: 1px;
            white-space: nowrap;
        }

        .mobile-menu-btn {
            display: none;
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.5rem;
        }

        .mobile-menu-btn svg {
            width: 24px;
            height: 24px;
            color: #1e3a8a;
        }

        .mobile-menu {
            display: none;
            position: fixed;
            top: 72px;
            left: 0;
            right: 0;
            background: white;
            padding: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 999;
        }

        .mobile-menu.active {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .mobile-menu a {
            text-decoration: none;
            color: #333;
            font-weight: 600;
            padding: 0.75rem;
            border-radius: 4px;
            transition: background-color 0.3s;
        }

        .mobile-menu a:hover {
            background-color: #f8fafc;
        }

        @media (max-width: 768px) {
            .nav-links {
                display: none;
            }
            .mobile-menu-btn {
                display: block;
            }
            .flex.items-center.space-x-4 {
                margin-left: auto;
            }
            .kyc-verified-badge {
                margin-right: 32px;
            }
        }

        /* Policy Item Styles */
        .policy-item {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .policy-item h3 {
            color: #1e3a8a;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }

        .policy-item p {
            margin: 8px 0;
            color: #333;
        }

        .policy-item p:first-of-type {
            font-weight: bold;
            color: #1e3a8a;
            background: #f8fafc;
            padding: 8px 12px;
            border-radius: 4px;
            display: inline-block;
        }

        .policy-item.error {
            border: 1px solid #dc3545;
            background: #fff5f5;
        }

        .error-message {
            color: #dc3545;
            font-weight: 500;
        }

        /* Policy Cards */
        .policy-card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin: 20px 0;
            padding: 20px;
        }

        .policy-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .policy-header h3 {
            margin: 0;
            color: #333;
        }

        .policy-id {
            background: #f0f7ff;
            color: #0066cc;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.9em;
        }

        .policy-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .detail-row {
            display: flex;
            flex-direction: column;
        }

        .detail-row .label {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .detail-row .value {
            color: #333;
            font-weight: 500;
        }

        .value.active {
            color: #4CAF50;
        }

        .value.inactive {
            color: #f44336;
        }

        .value.claimed {
            color: #f44336;
        }

        .value.unclaimed {
            color: #4CAF50;
        }

        .policy-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.3s;
        }

        .btn-primary {
            background-color: #4CAF50;
            color: white;
        }

        .btn-primary:hover {
            background-color: #45a049;
        }

        .btn-secondary {
            background-color: #f44336;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #da190b;
        }

        @media (max-width: 768px) {
            .policy-details {
                grid-template-columns: 1fr;
            }

            .policy-actions {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }
        }

        .policies-section {
            margin-top: 2rem;
        }

        .policies-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 1rem;
        }

        .policy-card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 1.5rem;
        }

        .policy-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #eee;
        }

        .policy-header h3 {
            margin: 0;
            color: #333;
        }

        .policy-id {
            background: #f0f7ff;
            color: #0066cc;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .policy-details {
            display: grid;
            gap: 0.75rem;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .detail-row .label {
            color: #666;
        }

        .detail-row .value {
            font-weight: 500;
        }

        .value.active {
            color: #4CAF50;
        }

        .value.inactive {
            color: #f44336;
        }

        .value.claimed {
            color: #f44336;
        }

        .value.unclaimed {
            color: #4CAF50;
        }

        .policy-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.3s;
        }

        .btn-primary {
            background-color: #4CAF50;
            color: white;
        }

        .btn-primary:hover {
            background-color: #45a049;
        }

        .btn-secondary {
            background-color: #f44336;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #da190b;
        }

        @media (max-width: 768px) {
            .policies-grid {
                grid-template-columns: 1fr;
            }

            .policy-actions {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }
        }

        .premium-actions {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .premium-actions .btn {
            flex: 1;
        }

        .btn-secondary {
            background-color: #2196F3;
        }

        .btn-secondary:hover {
            background-color: #1976D2;
        }

        .early-badge {
            background-color: #2196F3;
            color: white;
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 0.8em;
            margin-left: 8px;
        }

        /* Update nav container */
        .nav-container {
            display: flex;
            align-items: center;
            width: 100%;
            position: relative;
            padding-right: 80px; /* Make space for the KYC badge */
        }

        /* Update nav-links styles */
        .nav-links {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            margin-left: auto;
        }

        /* Update wallet section spacing */
        .wallet-section {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #f8fafc;
            padding: 6px 12px;
            border-radius: 8px;
            margin-right: 8px;
        }

        /* KYC Badge Styles */
        .kyc-verified-badge {
            margin-left: auto;
            display: flex;
            align-items: center;
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
        }

        .kyc-verified-badge .bg-green-100 {
            border: 1px solid #34d399;
        }

        .kyc-verified-badge .bg-blue-100 {
            border: 1px solid #60a5fa;
        }

        /* Add Claim Modal Styles */
        .claim-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            overflow-y: auto;
            padding: 20px;
        }

        .claim-modal-content {
            background-color: #ffffff;
            margin: 5% auto;
            padding: 2rem;
            border: 1px solid #ddd;
            width: 90%;
            max-width: 600px;
            border-radius: 12px;
            position: relative;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #eee;
        }

        .modal-header h2 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #2c3e50;
            margin: 0;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #666;
            cursor: pointer;
            padding: 0.5rem;
            line-height: 1;
        }

        .close-btn:hover {
            color: #333;
        }

        .claim-form {
            display: grid;
            gap: 1.5rem;
        }

        .form-group {
            display: grid;
            gap: 0.5rem;
        }

        .form-group label {
            font-weight: 500;
            color: #333;
            font-size: 0.95rem;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            background-color: #fff;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.1);
        }

        .form-group textarea {
            min-height: 120px;
            resize: vertical;
        }

        .file-upload {
            border: 2px dashed #ddd;
            padding: 2rem;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            background-color: #f8f9fa;
            transition: all 0.3s ease;
        }

        .file-upload:hover {
            border-color: #3498db;
            background-color: #f0f7ff;
        }

        .file-upload p {
            margin: 0.5rem 0;
            color: #666;
        }

        .file-upload p:first-child {
            font-weight: 500;
            color: #333;
        }

        .file-list {
            margin-top: 1rem;
            display: grid;
            gap: 0.5rem;
        }

        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #eee;
        }

        .file-item button {
            background: none;
            border: none;
            color: #dc3545;
            cursor: pointer;
            padding: 0.25rem 0.5rem;
            font-size: 1.1rem;
        }

        .form-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 1rem;
        }

        .form-actions button {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .form-actions .btn-primary {
            background-color: #3498db;
            color: white;
        }

        .form-actions .btn-primary:hover {
            background-color: #2980b9;
        }

        .form-actions .btn-secondary {
            background-color: #e9ecef;
            color: #495057;
        }

        .form-actions .btn-secondary:hover {
            background-color: #dee2e6;
        }

        @media (max-width: 640px) {
            .claim-modal-content {
                margin: 0 auto;
                padding: 1.5rem;
            }

            .form-actions {
                grid-template-columns: 1fr;
            }
        }

        /* Add Claims Section Styles */
        .claims-section {
            margin-top: 2rem;
            padding: 1rem;
        }

        .claims-section h2 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 1rem;
        }

        .claims-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .claim-card {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .claim-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #eee;
        }

        .claim-status {
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .claim-status.pending {
            background-color: #fff3cd;
            color: #856404;
        }

        .claim-status.approved {
            background-color: #d4edda;
            color: #155724;
        }

        .claim-status.rejected {
            background-color: #f8d7da;
            color: #721c24;
        }

        .claim-details {
            display: grid;
            gap: 0.75rem;
        }

        .claim-detail-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .claim-detail-row .label {
            color: #666;
            font-size: 0.9rem;
        }

        .claim-detail-row .value {
            font-weight: 500;
            color: #2c3e50;
        }

        .claim-documents {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #eee;
        }

        .claim-documents h4 {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 0.5rem;
        }

        .document-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .document-item {
            background: #f8f9fa;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            color: #495057;
        }

        .admin-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #eee;
        }

        .btn-approve {
            background-color: #4CAF50;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            flex: 1;
        }

        .btn-reject {
            background-color: #f44336;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            flex: 1;
        }

        .btn-approve:hover {
            background-color: #45a049;
        }

        .btn-reject:hover {
            background-color: #da190b;
        }
    </style>
    <script>
        // Contract ABIs and Addresses
        const insuranceABI = [
            "function submitClaim(uint256 policyId, uint256 amount, string memory claimType, string memory description) external returns (bool)",
            "function getPolicy(uint256 policyId) view returns (uint256 sumAssured, uint256 premium, uint256 startDate, uint256 endDate, bool isActive, uint256 lastPremiumPaid, bool isClaimed)",
            "function payPremium(uint256 policyId) payable",
            "function claim(uint256 policyId)",
            "function verifyClaim(uint256 policyId, bool approved) external returns (bool)",
            "function isAdmin(address account) external view returns (bool)",
            "function getPendingClaims() external view returns (uint256[])"
        ];
        const insuranceAddress = "0x5FbDB2315678afecb367f032d93F642f64180aa3";

        // Contract instances
        let contracts = {
            insuranceContract: null
        };

        // Global variables for wallet state
        let userAddress = null;
        let userWallet = null;

        // Function to check if MetaMask is installed
        function checkMetaMask() {
            return typeof window.ethereum !== 'undefined';
        }

        // Function to update dashboard stats
        function updateDashboardStats() {
            const totalPoliciesElement = document.getElementById('totalPolicies');
            const totalCoverageElement = document.getElementById('totalCoverage');
            const nextPremiumElement = document.getElementById('nextPremium');
            
            if (!isWalletConnected()) {
                totalPoliciesElement.textContent = '0';
                totalCoverageElement.textContent = '0 ETH';
                nextPremiumElement.textContent = '0 ETH';
                return;
            }

            const userPolicies = JSON.parse(localStorage.getItem('userPolicies') || '[]');
            const totalPolicies = userPolicies.length;
            const totalCoverage = userPolicies.reduce((sum, policy) => sum + parseFloat(policy.sumAssured), 0);
            
            let nextPremium = 0;
            const currentDate = new Date();
            userPolicies.forEach(policy => {
                const nextDueDate = new Date(policy.nextPremiumDue || new Date(policy.lastPremiumPaid).setMonth(new Date(policy.lastPremiumPaid).getMonth() + 1));
                if (nextDueDate > currentDate) {
                    nextPremium += parseFloat(policy.premium);
                }
            });

            totalPoliciesElement.textContent = totalPolicies;
            totalCoverageElement.textContent = `${totalCoverage.toFixed(3)} ETH`;
            nextPremiumElement.textContent = `${nextPremium.toFixed(3)} ETH`;
        }

        // Function to update wallet UI
        function updateWalletUI() {
            const walletBtn = document.getElementById('walletBtn');
            const walletStatus = document.getElementById('walletStatus');
            const walletAddress = document.getElementById('walletAddress');
            const kycBadge = document.querySelector('.kyc-verified-badge');

            if (userAddress) {
                walletBtn.classList.add('connected');
                walletBtn.textContent = 'Disconnect';
                walletStatus.textContent = 'Connected';
                const shortAddress = `${userAddress.slice(0, 6)}...${userAddress.slice(-4)}`;
                walletAddress.textContent = shortAddress;
                walletAddress.style.display = 'inline';

                const kycData = JSON.parse(localStorage.getItem('kycData') || '[]');
                const userKYC = kycData.find(k => k.walletAddress === userAddress);
                if (userKYC && userKYC.status === 'verified') {
                    kycBadge.classList.remove('hidden');
                } else {
                    kycBadge.classList.add('hidden');
                }

                // Update dashboard stats when wallet is connected
                updateDashboardStats();
            } else {
                walletBtn.classList.remove('connected');
                walletBtn.textContent = 'Connect Wallet';
                walletStatus.textContent = 'Not Connected';
                walletAddress.style.display = 'none';
                kycBadge.classList.add('hidden');
                // Reset dashboard stats when wallet is disconnected
                updateDashboardStats();
            }
        }

        // Function to connect wallet
        async function connectWallet() {
            const walletBtn = document.getElementById('walletBtn');
            try {
                walletBtn.classList.add('loading');
                walletBtn.textContent = 'Connecting...';
                
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                if (accounts.length > 0) {
                    userAddress = accounts[0];
                    userWallet = new ethers.providers.Web3Provider(window.ethereum);
                    localStorage.setItem('walletAddress', userAddress);
                    updateWalletUI();
                    
                    // Initialize contracts
                    const signer = userWallet.getSigner();
                    contracts.insuranceContract = new ethers.Contract(insuranceAddress, insuranceABI, signer);
                    
                    await loadPolicies();
                }
            } catch (error) {
                console.error('Error connecting wallet:', error);
                alert('Failed to connect wallet. Please try again.');
            } finally {
                walletBtn.classList.remove('loading');
            }
        }

        // Function to disconnect wallet
        async function disconnectWallet() {
            userAddress = null;
            userWallet = null;
            localStorage.removeItem('walletAddress');
            updateWalletUI();
            contracts.insuranceContract = null;
            
            // Clear policies display
            const policiesContainer = document.getElementById('policiesContainer');
            if (policiesContainer) {
                policiesContainer.innerHTML = '<div class="policy-card"><p>Please connect your wallet to view your policies.</p></div>';
            }
            
            // Clear claims display
            const claimsContainer = document.getElementById('claimsContainer');
            if (claimsContainer) {
                claimsContainer.innerHTML = '<div class="claim-card"><p>Please connect your wallet to view your claims.</p></div>';
            }
            
            // Reset dashboard stats
            updateDashboardStats();
        }

        // Function to check if wallet is connected
        function isWalletConnected() {
            return userAddress !== null && userWallet !== null;
        }

        // Function to handle wallet click
        async function handleWalletClick() {
            const walletBtn = document.getElementById('walletBtn');
            try {
                if (!window.ethereum) {
                    alert('Please install MetaMask to connect your wallet');
                    window.open('https://metamask.io/download/', '_blank');
                    return;
                }

                if (walletBtn.textContent === 'Disconnect') {
                    await disconnectWallet();
                } else {
                    await connectWallet();
                }
            } catch (error) {
                console.error('Error handling wallet click:', error);
                alert('Error handling wallet connection. Please try again.');
                walletBtn.classList.remove('loading');
                walletBtn.textContent = 'Connect Wallet';
            }
        }

        // Function to handle logout
        function logout() {
            localStorage.removeItem('isLoggedIn');
            localStorage.removeItem('userName');
            localStorage.removeItem('userEmail');
            localStorage.removeItem('walletAddress');
            window.location.href = '/';
        }

        // Function to load policies
        async function loadPolicies() {
            try {
                const userPolicies = JSON.parse(localStorage.getItem('userPolicies') || '[]');
                const policiesContainer = document.getElementById('policiesContainer');
                
                if (!policiesContainer) {
                    console.error('Policies container not found');
                    return;
                }

                // Check KYC status
                const kycData = JSON.parse(localStorage.getItem('kycData') || '[]');
                const userKYC = kycData.find(k => k.walletAddress === window.ethereum.selectedAddress);
                
                if (!userKYC) {
                    policiesContainer.innerHTML = `
                        <div class="policy-card">
                            <h2>KYC Verification Required</h2>
                            <p>Please complete your KYC verification before creating insurance policies.</p>
                            <a href="kyc.html" class="btn btn-primary">Complete KYC</a>
                        </div>
                    `;
                    return;
                }

                if (userKYC.status === 'pending') {
                    policiesContainer.innerHTML = `
                        <div class="policy-card">
                            <h2>KYC Verification Pending</h2>
                            <p>Your KYC verification is under review. Please wait for approval before creating insurance policies.</p>
                            <p>Status: Pending</p>
                        </div>
                    `;
                    return;
                }

                if (userKYC.status === 'rejected') {
                    policiesContainer.innerHTML = `
                        <div class="policy-card">
                            <h2>KYC Verification Rejected</h2>
                            <p>Your KYC verification was rejected. Please submit your documents again.</p>
                            <a href="kyc.html" class="btn btn-primary">Resubmit KYC</a>
                        </div>
                    `;
                    return;
                }

                // Calculate dashboard statistics
                const totalPolicies = userPolicies.length;
                const totalCoverage = userPolicies.reduce((sum, policy) => sum + parseFloat(policy.sumAssured), 0);
                
                // Calculate next premium
                let nextPremium = 0;
                const currentDate = new Date();
                userPolicies.forEach(policy => {
                    const nextDueDate = new Date(policy.nextPremiumDue || new Date(policy.lastPremiumPaid).setMonth(new Date(policy.lastPremiumPaid).getMonth() + 1));
                    if (nextDueDate > currentDate) {
                        nextPremium += parseFloat(policy.premium);
                    }
                });

                // Update dashboard statistics
                document.getElementById('totalPolicies').textContent = totalPolicies;
                document.getElementById('totalCoverage').textContent = `${totalCoverage.toFixed(3)} ETH`;
                document.getElementById('nextPremium').textContent = `${nextPremium.toFixed(3)} ETH`;

                if (userPolicies.length === 0) {
                    policiesContainer.innerHTML = '<div class="policy-card"><p>No policies found. Please purchase a policy first.</p></div>';
                    return;
                }

                policiesContainer.innerHTML = '';

                for (const policy of userPolicies) {
                    const policyCard = document.createElement('div');
                    policyCard.className = 'policy-card';
                    
                    // Format dates
                    const startDate = new Date(policy.startDate).toLocaleDateString();
                    const endDate = new Date(policy.endDate).toLocaleDateString();
                    const lastPremiumPaid = new Date(policy.lastPremiumPaid).toLocaleDateString();

                    // Calculate next premium date
                    const nextPremiumDate = new Date(policy.lastPremiumPaid);
                    nextPremiumDate.setFullYear(nextPremiumDate.getFullYear() + 1);

                    policyCard.innerHTML = `
                        <div class="policy-header">
                            <h3>${policy.type === 'term' ? 'Term Life Insurance' : 'Money-Back Insurance'}</h3>
                            <span class="policy-id">Policy ID: ${policy.id}</span>
                        </div>
                        <div class="policy-details">
                            <div class="detail-row">
                                <span class="label">Sum Assured:</span>
                                <span class="value">${policy.sumAssured} ETH (â‚¹${policy.type === 'term' ? '1 Cr' : '15 Lakhs'})</span>
                            </div>
                            <div class="detail-row">
                                <span class="label">Premium:</span>
                                <span class="value">${policy.type === 'term' 
                                    ? `${policy.premium} ETH (â‚¹499) / Year` 
                                    : `${policy.premium} ETH (â‚¹1,499) / Month`}</span>
                            </div>
                            <div class="detail-row">
                                <span class="label">Term:</span>
                                <span class="value">${policy.term} ${policy.type === 'term' ? 'Year' : 'Years'}</span>
                            </div>
                            <div class="detail-row">
                                <span class="label">Start Date:</span>
                                <span class="value">${startDate}</span>
                            </div>
                            <div class="detail-row">
                                <span class="label">End Date:</span>
                                <span class="value">${endDate}</span>
                            </div>
                            <div class="detail-row">
                                <span class="label">Last Premium Paid:</span>
                                <span class="value">${lastPremiumPaid}</span>
                            </div>
                            <div class="detail-row">
                                <span class="label">Next Premium Due:</span>
                                <span class="value">
                                    ${new Date(policy.nextPremiumDue || new Date(policy.lastPremiumPaid).setMonth(new Date(policy.lastPremiumPaid).getMonth() + 1)).toLocaleDateString()}
                                    ${policy.premiumHistory?.some(p => p.isEarlyPayment && new Date(p.nextDueDate) > new Date()) ? 
                                        '<span class="early-badge">Early Payment</span>' : ''}
                                </span>
                            </div>
                            <div class="detail-row">
                                <span class="label">Status:</span>
                                <span class="value ${policy.isActive ? 'active' : 'inactive'}">${policy.isActive ? 'Active' : 'Inactive'}</span>
                            </div>
                            <div class="detail-row">
                                <span class="label">Claim Status:</span>
                                <span class="value ${policy.isClaimed ? 'claimed' : 'unclaimed'}">${policy.isClaimed ? 'Claimed' : 'Unclaimed'}</span>
                            </div>
                        </div>
                        <div class="policy-actions">
                            <div class="premium-actions">
                                <button onclick="payPremium('${policy.type}')" class="btn btn-primary">Pay Current Premium</button>
                                <button onclick="payEarlyPremium('${policy.type}')" class="btn btn-secondary">Pay Early Premium</button>
                            </div>
                            ${!policy.isClaimed ? `<button onclick="openClaimModal('${policy.id}')" class="btn btn-secondary">Submit Claim</button>` : ''}
                        </div>
                        ${policy.premiumHistory?.length > 0 ? `
                            <div class="premium-history">
                                <h4>Premium Payment History</h4>
                                <div class="premium-history-list">
                                    ${policy.premiumHistory.map(payment => `
                                        <div class="premium-payment-item">
                                            <span class="payment-date">${new Date(payment.date).toLocaleDateString()}</span>
                                            <span class="payment-amount">${payment.amount} ETH</span>
                                            <span class="payment-status ${payment.status}">${payment.status}</span>
                                            <span class="payment-type">
                                                ${payment.isEarlyPayment ? 
                                                    `<span class="early-badge">Early Payment</span>` : 
                                                    'Regular Payment'}
                                            </span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                    `;

                    // Add styles for premium history
                    const style = document.createElement('style');
                    style.textContent = `
                        .premium-history {
                            margin-top: 1rem;
                            padding-top: 1rem;
                            border-top: 1px solid #eee;
                        }

                        .premium-history h4 {
                            color: #1e3a8a;
                            margin-bottom: 0.5rem;
                        }

                        .premium-history-list {
                            max-height: 200px;
                            overflow-y: auto;
                        }

                        .premium-payment-item {
                            display: grid;
                            grid-template-columns: 1fr 1fr 1fr 1fr;
                            gap: 1rem;
                            padding: 0.5rem;
                            border-bottom: 1px solid #eee;
                            font-size: 0.9rem;
                        }

                        .premium-payment-item:last-child {
                            border-bottom: none;
                        }

                        .payment-date {
                            color: #666;
                        }

                        .payment-amount {
                            font-weight: 500;
                        }

                        .payment-status {
                            text-transform: capitalize;
                        }

                        .payment-status.paid {
                            color: #4CAF50;
                        }

                        .payment-status.pending {
                            color: #FFA500;
                        }

                        .payment-status.failed {
                            color: #f44336;
                        }

                        .tx-link {
                            color: #0066cc;
                            text-decoration: none;
                        }

                        .tx-link:hover {
                            text-decoration: underline;
                        }

                        @media (max-width: 768px) {
                            .premium-payment-item {
                                grid-template-columns: 1fr;
                                gap: 0.25rem;
                            }
                        }
                    `;
                    document.head.appendChild(style);

                    policiesContainer.appendChild(policyCard);
                }
            } catch (error) {
                console.error('Error loading policies:', error);
                alert('Error loading policies. Please try again.');
            }
        }

        // Function to pay premium
        async function payPremium(policyType) {
            try {
                if (!window.ethereum || !window.ethereum.selectedAddress) {
                    alert('Please connect your wallet first');
                    return;
                }

                const provider = new ethers.providers.Web3Provider(window.ethereum);
                const signer = provider.getSigner();
                
                // Get the appropriate contract based on policy type
                const contract = new ethers.Contract(insuranceAddress, insuranceABI, signer);

                // Get premium amount in ETH
                const premiumAmount = policyType === 'term' 
                    ? ethers.utils.parseEther('0.499') // â‚¹499
                    : ethers.utils.parseEther('1.499'); // â‚¹1,499

                // Get user's policies
                const userPolicies = JSON.parse(localStorage.getItem('userPolicies') || '[]');
                const userPoliciesOfType = userPolicies.filter(p => p.type === policyType);

                if (userPoliciesOfType.length === 0) {
                    alert('You need to create a policy first before paying premium');
                    return;
                }

                // Get the most recent policy
                const latestPolicy = userPoliciesOfType[userPoliciesOfType.length - 1];

                // Check if there's an early payment for the current period
                const currentDate = new Date();
                const hasEarlyPayment = latestPolicy.premiumHistory?.some(payment => 
                    payment.isEarlyPayment && 
                    new Date(payment.nextDueDate).getTime() > currentDate.getTime()
                );

                if (hasEarlyPayment) {
                    const nextDueDate = latestPolicy.premiumHistory
                        .filter(p => p.isEarlyPayment)
                        .sort((a, b) => new Date(b.nextDueDate) - new Date(a.nextDueDate))[0]
                        .nextDueDate;
                    
                    alert(`Premium is already paid early until ${new Date(nextDueDate).toLocaleDateString()}. Please wait until then.`);
                    return;
                }

                // Pay premium
                const tx = await contract.payPremium(latestPolicy.id, {
                    value: premiumAmount
                });

                // Wait for transaction to be mined
                const receipt = await tx.wait();

                // Initialize premium history if it doesn't exist
                if (!latestPolicy.premiumHistory) {
                    latestPolicy.premiumHistory = [];
                }

                // Calculate next premium date
                const nextPremiumDate = new Date(currentDate);
                nextPremiumDate.setMonth(nextPremiumDate.getMonth() + 1);

                // Add new premium payment to history
                const newPayment = {
                    date: currentDate.toISOString(),
                    amount: policyType === 'term' ? '0.499' : '1.499',
                    status: 'paid',
                    transactionHash: receipt.transactionHash,
                    isEarlyPayment: false,
                    nextDueDate: nextPremiumDate.toISOString()
                };

                latestPolicy.premiumHistory.push(newPayment);
                
                // Update the last premium paid date and next premium due date
                latestPolicy.lastPremiumPaid = currentDate.toISOString();
                latestPolicy.nextPremiumDue = nextPremiumDate.toISOString();

                // Update the policy in the userPolicies array
                const policyIndex = userPolicies.findIndex(p => p.id === latestPolicy.id);
                if (policyIndex !== -1) {
                    userPolicies[policyIndex] = latestPolicy;
                }

                // Save updated policies to localStorage
                localStorage.setItem('userPolicies', JSON.stringify(userPolicies));

                // Show success message
                alert(`Premium paid successfully!\nNext premium due: ${nextPremiumDate.toLocaleDateString()}`);
                
                // Reload policies to show updated information
                loadPolicies();
            } catch (error) {
                console.error('Error paying premium:', error);
                alert('Error paying premium: ' + error.message);
            }
        }

        // Add early premium payment function
        async function payEarlyPremium(policyType) {
            try {
                if (!window.ethereum || !window.ethereum.selectedAddress) {
                    alert('Please connect your wallet first');
                    return;
                }

                const provider = new ethers.providers.Web3Provider(window.ethereum);
                const signer = provider.getSigner();
                
                // Get the appropriate contract based on policy type
                const contract = new ethers.Contract(insuranceAddress, insuranceABI, signer);

                // Get premium amount in ETH
                const premiumAmount = policyType === 'term' 
                    ? ethers.utils.parseEther('0.499') // â‚¹499 yearly
                    : ethers.utils.parseEther('1.499'); // â‚¹1,499 monthly

                // Get user's policies
                const userPolicies = JSON.parse(localStorage.getItem('userPolicies') || '[]');
                const userPoliciesOfType = userPolicies.filter(p => p.type === policyType);

                if (userPoliciesOfType.length === 0) {
                    alert('You need to create a policy first before paying premium');
                    return;
                }

                // Get the most recent policy
                const latestPolicy = userPoliciesOfType[userPoliciesOfType.length - 1];

                // Calculate next premium date
                const lastPremiumDate = new Date(latestPolicy.lastPremiumPaid);
                const nextPremiumDate = new Date(lastPremiumDate);
                nextPremiumDate.setMonth(nextPremiumDate.getMonth() + 1);

                // Check if premium is already paid for next period
                const currentDate = new Date();
                
                // Check if trying to pay more than one month early
                const oneMonthFromNow = new Date(currentDate);
                oneMonthFromNow.setMonth(oneMonthFromNow.getMonth() + 1);
                
                if (currentDate < nextPremiumDate) {
                    // Check if trying to pay more than one month early
                    if (nextPremiumDate > oneMonthFromNow) {
                        alert('You can only pay up to one month early. Please wait until closer to the due date.');
                        return;
                    }

                    // Check if there's already an early payment for this period
                    const hasEarlyPayment = latestPolicy.premiumHistory?.some(payment => 
                        payment.isEarlyPayment && 
                        new Date(payment.nextDueDate).getTime() === nextPremiumDate.getTime()
                    );

                    if (hasEarlyPayment) {
                        alert('Early premium is already paid for this period. Please wait until the next premium is due.');
                        return;
                    }

                    // Confirm early payment
                    const confirmPayment = confirm(`Are you sure you want to pay the next premium early?\nAmount: ${policyType === 'term' ? '0.499 ETH (â‚¹499)' : '1.499 ETH (â‚¹1,499)'}\nNext Premium Due: ${nextPremiumDate.toLocaleDateString()}`);
                    
                    if (!confirmPayment) {
                        return;
                    }

                    // Pay premium
                    const tx = await contract.payPremium(latestPolicy.id, {
                        value: premiumAmount
                    });

                    // Wait for transaction to be mined
                    const receipt = await tx.wait();
                    console.log('Early premium payment transaction:', receipt);

                    // Initialize premium history if it doesn't exist
                    if (!latestPolicy.premiumHistory) {
                        latestPolicy.premiumHistory = [];
                    }

                    // Calculate the new next premium date (one month from current date)
                    const newNextPremiumDate = new Date(currentDate);
                    newNextPremiumDate.setMonth(newNextPremiumDate.getMonth() + 1);

                    // Add new premium payment to history
                    const newPayment = {
                        date: currentDate.toISOString(),
                        amount: policyType === 'term' ? '0.499' : '1.499',
                        status: 'paid',
                        transactionHash: receipt.transactionHash,
                        isEarlyPayment: true,
                        nextDueDate: newNextPremiumDate.toISOString(),
                        paymentType: 'early'
                    };

                    latestPolicy.premiumHistory.push(newPayment);
                    
                    // Update the last premium paid date and next premium due date
                    latestPolicy.lastPremiumPaid = currentDate.toISOString();
                    latestPolicy.nextPremiumDue = newNextPremiumDate.toISOString();

                    // Update the policy in the userPolicies array
                    const policyIndex = userPolicies.findIndex(p => p.id === latestPolicy.id);
                    if (policyIndex !== -1) {
                        userPolicies[policyIndex] = latestPolicy;
                    }

                    // Save updated policies to localStorage
                    localStorage.setItem('userPolicies', JSON.stringify(userPolicies));

                    // Show success message with next due date
                    alert(`Early premium paid successfully!\nNext premium due: ${newNextPremiumDate.toLocaleDateString()}`);
                    
                    // Reload policies to show updated information
                    loadPolicies();
                } else {
                    alert('Premium is already paid for the next period. Please wait until the next premium is due.');
                }
            } catch (error) {
                console.error('Error paying early premium:', error);
                alert('Error paying early premium: ' + error.message);
            }
        }

        // Initialize wallet on page load
        window.addEventListener('load', async function() {
            try {
                // Set up wallet button click handler
                const walletBtn = document.getElementById('walletBtn');
                if (walletBtn) {
                    walletBtn.addEventListener('click', handleWalletClick);
                }

                // Set up claim form event listener
                const claimForm = document.getElementById('claimForm');
                if (claimForm) {
                    claimForm.addEventListener('submit', submitClaim);
                }

                // Set up file input event listener
                const fileInput = document.getElementById('fileInput');
                if (fileInput) {
                    fileInput.addEventListener('change', handleFileSelect);
                }

                // Set up mobile menu toggle
                const mobileMenuBtn = document.querySelector('.mobile-menu-btn');
                if (mobileMenuBtn) {
                    mobileMenuBtn.addEventListener('click', toggleMobileMenu);
                }

                // Set up modal close button
                const closeBtn = document.querySelector('.close-btn');
                if (closeBtn) {
                    closeBtn.addEventListener('click', closeClaimModal);
                }

                // Set up modal close on outside click
                const claimModal = document.getElementById('claimModal');
                if (claimModal) {
                    claimModal.addEventListener('click', function(event) {
                        if (event.target === claimModal) {
                            closeClaimModal();
                        }
                    });
                }

                // Check if wallet was previously connected
                const savedAddress = localStorage.getItem('walletAddress');
                if (savedAddress) {
                    userAddress = savedAddress;
                    userWallet = new ethers.providers.Web3Provider(window.ethereum);
                    updateWalletUI();
                    
                    // Initialize contracts
                    const signer = userWallet.getSigner();
                    contracts.insuranceContract = new ethers.Contract(insuranceAddress, insuranceABI, signer);
                    
                    loadPolicies();
                }

                // Initialize dashboard stats
                updateDashboardStats();
            } catch (error) {
                console.error('Error during initialization:', error);
            }
        });

        // Function to show KYC notice and hide dashboard
        function showKYCNotice(message) {
            const dashboardContent = document.getElementById('dashboardContent');
            const kycNotice = document.getElementById('kycNotice');
            
            if (dashboardContent) {
                dashboardContent.style.display = 'none';
            }
            
            if (kycNotice) {
                kycNotice.innerHTML = `
                    <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-8">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <svg class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm text-yellow-700">${message}</p>
                                <div class="mt-4">
                                    <a href="kyc.html" class="inline-flex items-center px-4 py-2 border border-transparent text-sm leading-5 font-medium rounded-md text-yellow-700 bg-yellow-100 hover:bg-yellow-50 focus:outline-none focus:border-yellow-300 focus:shadow-outline-yellow active:bg-yellow-200 transition ease-in-out duration-150">
                                        Complete KYC Verification
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                kycNotice.style.display = 'block';
            }
        }

        // Function to show dashboard content
        function showDashboard(userKYC) {
            const dashboardContent = document.getElementById('dashboardContent');
            const kycNotice = document.getElementById('kycNotice');
            const userInfo = document.getElementById('userInfo');
            
            if (kycNotice) {
                kycNotice.style.display = 'none';
            }
            
            if (dashboardContent) {
                dashboardContent.style.display = 'block';
            }

            // Update user info section
            if (userInfo) {
                userInfo.innerHTML = `
                    <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-xl font-semibold text-gray-800">User Information</h2>
                            <span class="px-3 py-1 text-sm text-green-800 bg-green-100 rounded-full">Verified</span>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <p class="text-sm text-gray-600">Full Name</p>
                                <p class="text-base font-medium">${userKYC.personalInfo.fullName}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Email</p>
                                <p class="text-base font-medium">${userKYC.personalInfo.email}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Phone</p>
                                <p class="text-base font-medium">${userKYC.personalInfo.phone}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Wallet Address</p>
                                <p class="text-base font-medium text-blue-600">${userKYC.walletAddress.substring(0, 6)}...${userKYC.walletAddress.substring(38)}</p>
                            </div>
                        </div>
                        <div class="mt-4 pt-4 border-t">
                            <p class="text-sm text-gray-600">KYC Verification Date</p>
                            <p class="text-base font-medium">${new Date(userKYC.documents.verificationDate).toLocaleDateString()}</p>
                        </div>
                    </div>
                `;
            }

            // Load and display user's policies
            loadUserPolicies(userKYC.walletAddress);
        }

        // Function to load user's insurance policies
        async function loadUserPolicies(walletAddress) {
            const policiesSection = document.getElementById('policiesSection');
            if (!policiesSection) return;

            try {
                // Get policies from localStorage (you can replace this with blockchain data)
                const policies = JSON.parse(localStorage.getItem('policies') || '[]');
                const userPolicies = policies.filter(p => p.walletAddress === walletAddress);

                if (userPolicies.length === 0) {
                    policiesSection.innerHTML = `
                        <div class="bg-white rounded-lg shadow-md p-6">
                            <div class="text-center py-8">
                                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                </svg>
                                <h3 class="mt-2 text-sm font-medium text-gray-900">No policies found</h3>
                                <p class="mt-1 text-sm text-gray-500">Get started by creating a new policy.</p>
                                <div class="mt-6">
                                    <a href="life-insurance.html" class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">
                                        <svg class="-ml-1 mr-2 h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                                        </svg>
                                        Create New Policy
                                    </a>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    policiesSection.innerHTML = `
                        <div class="bg-white rounded-lg shadow-md p-6">
                            <div class="flex items-center justify-between mb-6">
                                <h2 class="text-xl font-semibold text-gray-800">Your Insurance Policies</h2>
                                <a href="life-insurance.html" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">
                                    <svg class="-ml-1 mr-2 h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                                    </svg>
                                    New Policy
                                </a>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                ${userPolicies.map(policy => `
                                    <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                                        <div class="flex items-center justify-between mb-3">
                                            <span class="text-sm font-medium text-blue-600">${policy.type}</span>
                                            <span class="px-2 py-1 text-xs text-green-800 bg-green-100 rounded-full">Active</span>
                                        </div>
                                        <h3 class="text-lg font-medium text-gray-900 mb-2">${policy.name}</h3>
                                        <div class="text-sm text-gray-600 space-y-1">
                                            <p>Policy ID: ${policy.id}</p>
                                            <p>Coverage: â‚¹${policy.coverage.toLocaleString()}</p>
                                            <p>Premium: â‚¹${policy.premium.toLocaleString()}/month</p>
                                            <p>Start Date: ${new Date(policy.startDate).toLocaleDateString()}</p>
                                        </div>
                                        <button onclick="viewPolicyDetails('${policy.id}')" class="mt-4 w-full inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-blue-700 bg-blue-100 hover:bg-blue-200">
                                            View Details
                                        </button>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading policies:', error);
                policiesSection.innerHTML = `
                    <div class="bg-red-50 border-l-4 border-red-400 p-4">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm text-red-700">Error loading policies. Please try again later.</p>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        // Function to view policy details
        function viewPolicyDetails(policyId) {
            // Implement policy details view
            window.location.href = `policy-details.html?id=${policyId}`;
        }

        // Additional functions for dashboard features
        function viewAllPolicies() {
            // Implement view all policies functionality
            window.location.href = 'policies.html';
        }

        function downloadKYC() {
            try {
                // Get KYC data
                const kycData = JSON.parse(localStorage.getItem('kycData') || '[]');
                const kycArray = Array.isArray(kycData) ? kycData : [kycData];
                const userKYC = kycArray.find(k => k && k.walletAddress === window.ethereum.selectedAddress);

                if (!userKYC) {
                    alert('KYC data not found');
                    return;
                }

                // Create a formatted KYC details string
                const kycDetails = `
KYC VERIFICATION DETAILS
-----------------------
Full Name: ${userKYC.personalInfo.fullName}
Email: ${userKYC.personalInfo.email}
Phone: ${userKYC.personalInfo.phone}
Wallet Address: ${userKYC.walletAddress}
Verification Date: ${new Date(userKYC.documents.verificationDate).toLocaleString()}
Status: ${userKYC.status.toUpperCase()}
                `.trim();

                // Create blob and download
                const blob = new Blob([kycDetails], { type: 'text/plain' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'KYC_Details.txt';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            } catch (error) {
                console.error('Error downloading KYC details:', error);
                alert('Error downloading KYC details. Please try again.');
            }
        }

        // Update recent activities
        function updateRecentActivities() {
            const recentActivities = document.getElementById('recentActivities');
            const kycVerificationDate = document.getElementById('kycVerificationDate');
            
            try {
                const kycData = JSON.parse(localStorage.getItem('kycData') || '[]');
                const kycArray = Array.isArray(kycData) ? kycData : [kycData];
                const userKYC = kycArray.find(k => k && k.walletAddress === window.ethereum.selectedAddress);

                if (userKYC) {
                    kycVerificationDate.textContent = new Date(userKYC.documents.verificationDate).toLocaleString();
                }

                // Get policies for activity list
                const policies = JSON.parse(localStorage.getItem('policies') || '[]');
                const userPolicies = policies.filter(p => p.walletAddress === window.ethereum.selectedAddress);

                if (userPolicies.length > 0) {
                    const activitiesHTML = userPolicies.map(policy => `
                        <div class="flex items-center justify-between py-3 border-b">
                            <div>
                                <p class="text-sm font-medium text-gray-900">Policy Created: ${policy.name}</p>
                                <p class="text-sm text-gray-500">${new Date(policy.startDate).toLocaleString()}</p>
                            </div>
                            <span class="px-2 py-1 text-xs text-blue-800 bg-blue-100 rounded-full">New Policy</span>
                        </div>
                    `).join('');
                    recentActivities.innerHTML = activitiesHTML;
                } else {
                    recentActivities.innerHTML = `
                        <div class="text-center py-4 text-gray-500">
                            No recent policy activities
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error updating recent activities:', error);
                recentActivities.innerHTML = `
                    <div class="text-center py-4 text-red-500">
                        Error loading recent activities
                    </div>
                `;
            }
        }

        // Call updateRecentActivities when showing dashboard
        const originalShowDashboard = showDashboard;
        showDashboard = function(userKYC) {
            originalShowDashboard(userKYC);
            updateRecentActivities();
        };

        // Add Claim Functionality
        let currentPolicyId = null;

        function openClaimModal(policyId) {
            currentPolicyId = policyId;
            const modal = document.getElementById('claimModal');
            const form = document.getElementById('claimForm');
            const fileList = document.getElementById('fileList');
            
            if (modal) modal.style.display = 'block';
            if (form) form.reset();
            if (fileList) fileList.innerHTML = '';

            // Pre-fill wallet address if available
            const walletAddressInput = document.getElementById('walletAddress');
            if (walletAddressInput && window.ethereum && window.ethereum.selectedAddress) {
                walletAddressInput.value = window.ethereum.selectedAddress;
            }
        }

        function closeClaimModal() {
            const modal = document.getElementById('claimModal');
            if (modal) modal.style.display = 'none';
            currentPolicyId = null;
        }

        function handleFileSelect(event) {
            const files = event.target.files;
            const fileList = document.getElementById('fileList');
            if (!fileList) return;

            fileList.innerHTML = '';

            for (let file of files) {
                if (file.size > 5 * 1024 * 1024) {
                    alert('File size should not exceed 5MB');
                    continue;
                }

                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <span>${file.name}</span>
                    <button type="button" onclick="this.parentElement.remove()">Ã—</button>
                `;
                fileList.appendChild(fileItem);
            }
        }

        // Initialize event listeners when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Set up claim form submission
            const claimForm = document.getElementById('claimForm');
            if (claimForm) {
                claimForm.addEventListener('submit', async function(event) {
                    event.preventDefault();
                    
                    try {
                        console.log('Starting claim submission...');

                        // Get form data
                        const policyId = currentPolicyId;
                        console.log('Policy ID:', policyId);
                        
                        // Get form elements and their values
                        const claimType = document.getElementById('claimType')?.value || '';
                        const claimAmount = document.getElementById('claimAmount')?.value || '';
                        const walletAddress = document.getElementById('walletAddress')?.value || '';
                        const description = document.getElementById('description')?.value || '';
                        const fileInput = document.getElementById('fileInput');

                        // Debug log
                        console.log('Form Values:', {
                            policyId,
                            claimType,
                            claimAmount,
                            walletAddress,
                            description,
                            filesCount: fileInput?.files?.length || 0
                        });

                        // Basic form validation
                        if (!claimType || !claimAmount || !walletAddress || !description) {
                            alert('Please fill in all required fields');
                            return;
                        }

                        if (!fileInput || !fileInput.files || fileInput.files.length === 0) {
                            alert('Please upload at least one supporting document');
                            return;
                        }

                        // Process documents
                        const documentInfo = Array.from(fileInput.files).map(file => ({
                            name: file.name,
                            size: file.size,
                            type: file.type
                        }));

                        // Get user's policy details
                        const userPolicies = JSON.parse(localStorage.getItem('userPolicies') || '[]');
                        const policy = userPolicies.find(p => p.id === policyId);
                        
                        if (!policy) {
                            console.error('Policy not found:', policyId);
                            alert('Error: Policy not found');
                            return;
                        }

                        // Create claim data
                        const claimData = {
                            policyId,
                            walletAddress,
                            claimType,
                            amount: parseFloat(claimAmount),
                            description,
                            documents: documentInfo,
                            status: 'pending',
                            submissionDate: new Date().toISOString(),
                            policyType: policy.type
                        };

                        console.log('Submitting claim data:', claimData);

                        // Update user policies
                        policy.claimDetails = {
                            type: claimType,
                            amount: claimAmount,
                            walletAddress: walletAddress,
                            description: description,
                            documents: documentInfo,
                            status: 'pending',
                            submissionDate: new Date().toISOString()
                        };
                        policy.isClaimed = true;

                        // Save updated user policies
                        localStorage.setItem('userPolicies', JSON.stringify(userPolicies));

                        // Add to admin claims
                        const adminClaims = JSON.parse(localStorage.getItem('adminClaims') || '[]');
                        adminClaims.push(claimData);
                        localStorage.setItem('adminClaims', JSON.stringify(adminClaims));

                        // Update stats
                        const stats = {
                            totalClaims: adminClaims.length,
                            pendingClaims: adminClaims.filter(c => c.status === 'pending').length
                        };
                        localStorage.setItem('claimStats', JSON.stringify(stats));

                        alert('Claim submitted successfully!');
                        closeClaimModal();
                        loadPolicies(); // Refresh policies display

                    } catch (error) {
                        console.error('Error submitting claim:', error);
                        alert('Error submitting claim: ' + error.message);
                    }
                });
            }

            // Set up file input handler
            const fileInput = document.getElementById('fileInput');
            if (fileInput) {
                fileInput.addEventListener('change', handleFileSelect);
            }
        });

        // Modify loadClaims function to work without admin check
        async function loadClaims() {
            const claimsContainer = document.getElementById('claimsContainer');
            if (!claimsContainer) return;

            try {
                // Load user's claims
                const userPolicies = JSON.parse(localStorage.getItem('userPolicies') || '[]');
                const claimedPolicies = userPolicies.filter(policy => policy.isClaimed && policy.claimDetails);

                if (claimedPolicies.length === 0) {
                    claimsContainer.innerHTML = `
                        <div class="claim-card">
                            <p class="text-center text-gray-500">No claims submitted yet.</p>
                        </div>
                    `;
                    return;
                }

                claimsContainer.innerHTML = '';
                
                for (const policy of claimedPolicies) {
                    const claimCard = document.createElement('div');
                    claimCard.className = 'claim-card';
                    
                    const statusClass = {
                        'pending': 'pending',
                        'approved': 'approved',
                        'rejected': 'rejected'
                    }[policy.claimDetails.status] || 'pending';

                    claimCard.innerHTML = `
                        <div class="claim-header">
                            <h3>Claim #${policy.id}</h3>
                            <span class="claim-status ${statusClass}">${policy.claimDetails.status.charAt(0).toUpperCase() + policy.claimDetails.status.slice(1)}</span>
                        </div>
                        <div class="claim-details">
                            <div class="claim-detail-row">
                                <span class="label">Policy Type:</span>
                                <span class="value">${policy.type === 'term' ? 'Term Life Insurance' : 'Money-Back Insurance'}</span>
                            </div>
                            <div class="claim-detail-row">
                                <span class="label">Claim Type:</span>
                                <span class="value">${policy.claimDetails.type}</span>
                            </div>
                            <div class="claim-detail-row">
                                <span class="label">Amount:</span>
                                <span class="value">${policy.claimDetails.amount} ETH</span>
                            </div>
                            <div class="claim-detail-row">
                                <span class="label">Submission Date:</span>
                                <span class="value">${new Date(policy.claimDetails.submissionDate).toLocaleDateString()}</span>
                            </div>
                            <div class="claim-detail-row">
                                <span class="label">Description:</span>
                                <span class="value">${policy.claimDetails.description}</span>
                            </div>
                        </div>
                        <div class="claim-documents">
                            <h4>Supporting Documents</h4>
                            <div class="document-list">
                                ${policy.claimDetails.documents ? 
                                    policy.claimDetails.documents.map(doc => `
                                        <span class="document-item">${doc.name}</span>
                                    `).join('') : 
                                    '<span class="text-gray-500">No documents available</span>'
                                }
                            </div>
                        </div>
                    `;
                    
                    claimsContainer.appendChild(claimCard);
                }
            } catch (error) {
                console.error('Error loading claims:', error);
                claimsContainer.innerHTML = `
                    <div class="claim-card">
                        <p class="text-center text-red-500">Error loading claims. Please try again.</p>
                    </div>
                `;
            }
        }

        // Add function for admin to verify claims
        async function verifyClaim(policyId, isApproved) {
            try {
                const provider = new ethers.providers.Web3Provider(window.ethereum);
                const signer = provider.getSigner();
                const insuranceContract = new ethers.Contract(insuranceAddress, insuranceABI, signer);

                // Call smart contract to verify claim
                const tx = await insuranceContract.verifyClaim(policyId, isApproved);
                await tx.wait();

                // Update admin claims
                const adminClaims = JSON.parse(localStorage.getItem('adminClaims') || '[]');
                const claimIndex = adminClaims.findIndex(claim => claim.policyId === policyId);
                if (claimIndex !== -1) {
                    adminClaims[claimIndex].status = isApproved ? 'approved' : 'rejected';
                    localStorage.setItem('adminClaims', JSON.stringify(adminClaims));
                }

                // Update user's policy
                const userPolicies = JSON.parse(localStorage.getItem('userPolicies') || '[]');
                const policy = userPolicies.find(p => p.id === policyId);
                if (policy) {
                    policy.claimDetails.status = isApproved ? 'approved' : 'rejected';
                    localStorage.setItem('userPolicies', JSON.stringify(userPolicies));
                }

                alert(`Claim ${isApproved ? 'approved' : 'rejected'} successfully!`);
                loadClaims(); // Refresh the claims display

            } catch (error) {
                console.error('Error verifying claim:', error);
                alert('Error verifying claim: ' + error.message);
            }
        }

        // Add function to check if user is admin
        async function isAdmin(address) {
            try {
                const provider = new ethers.providers.Web3Provider(window.ethereum);
                const insuranceContract = new ethers.Contract(insuranceAddress, insuranceABI, provider);
                return await insuranceContract.isAdmin(address);
            } catch (error) {
                console.error('Error checking admin status:', error);
                return false;
            }
        }

        // Update loadPolicies function to also load claims
        const originalLoadPolicies = loadPolicies;
        loadPolicies = async function() {
            await originalLoadPolicies();
            await loadClaims();
        };

        // Add initializeWeb3 function
        async function initializeWeb3() {
            try {
                if (!window.ethereum) {
                    throw new Error('MetaMask is not installed');
                }

                // Request account access
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                if (accounts.length > 0) {
                    userAddress = accounts[0];
                    userWallet = new ethers.providers.Web3Provider(window.ethereum);
                    localStorage.setItem('walletAddress', userAddress);
                    updateWalletUI();
                    
                    // Initialize contracts
                    const signer = userWallet.getSigner();
                    contracts.insuranceContract = new ethers.Contract(insuranceAddress, insuranceABI, signer);
                    
                    await loadPolicies();
                }
            } catch (error) {
                console.error('Error initializing Web3:', error);
                throw error;
            }
        }
    </script>
</head>
<body>
    <header>
        <nav>
            <div class="logo">
                <a href="/"><img src="logo.png" alt="InsurEdge Logo"></a>
            </div>
            <div class="nav-links">
                <a href="/">Home</a>
                <a href="/life-insurance.html">Life Insurance</a>
                <a href="/dashboard.html">Dashboard</a>
            </div>
            <div class="flex items-center space-x-4">
                <div class="wallet-section">
                    <button id="walletBtn" class="wallet-btn">
                        <svg class="wallet-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
                        </svg>
                        Connect Wallet
                    </button>
                    <span id="walletAddress" class="wallet-address"></span>
                    <span id="walletStatus" class="wallet-status">Not Connected</span>
                </div>
                <div class="kyc-verified-badge hidden">
                    <span class="kyc-status">KYC âœ“</span>
                </div>
            </div>
            <button class="mobile-menu-btn md:hidden">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                </svg>
            </button>
        </nav>
        <div id="mobileMenu" class="mobile-menu hidden">
            <a href="/">Home</a>
            <a href="/life-insurance.html">Life Insurance</a>
            <a href="/dashboard.html">Dashboard</a>
        </div>
    </header>

    <div class="dashboard-container">
        <div class="dashboard-header">
            <h1>Insurance Dashboard</h1>
        </div>

        <div class="dashboard-stats">
            <div class="stat-card">
                <h3>Total Policies</h3>
                <p id="totalPolicies">0</p>
            </div>
            <div class="stat-card">
                <h3>Total Coverage</h3>
                <p id="totalCoverage">0 ETH</p>
            </div>
            <div class="stat-card">
                <h3>Next Premium</h3>
                <p id="nextPremium">0 ETH</p>
            </div>
        </div>

        <div class="policies-section">
            <h2>Your Policies</h2>
            <div id="policiesContainer" class="policies-grid">
                <!-- Policies will be loaded here -->
            </div>
        </div>

        <!-- Add Claims Section -->
        <div class="claims-section">
            <h2>Claims History</h2>
            <div id="claimsContainer" class="claims-grid">
                <!-- Claims will be loaded here -->
            </div>
        </div>
    </div>

    <footer>
        <div class="footer-content">
            <div class="footer-section">
                <h3>About InsurEdge</h3>
                <p>Your trusted partner in decentralized insurance solutions.</p>
            </div>
            <div class="footer-section">
                <h3>Quick Links</h3>
                <ul>
                    <li><a href="/">Home</a></li>
                    <li><a href="/life-insurance">Life Insurance</a></li>
                    <li><a href="/dashboard">Dashboard</a></li>
                </ul>
            </div>
            <div class="footer-section">
                <h3>Contact Us</h3>
                <p>Email: support@insuredge.com</p>
                <p>Phone: (555) 123-4567</p>
            </div>
        </div>
        <div class="footer-bottom">
            <p>&copy; 2024 InsurEdge. All rights reserved.</p>
        </div>
    </footer>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
        <!-- KYC Notice Section -->
        <div id="kycNotice" class="max-w-7xl mx-auto" style="display: none;"></div>

        <!-- Dashboard Content -->
        <div id="dashboardContent" class="max-w-7xl mx-auto" style="display: none;">
            <!-- Add KYC Banner at the top of dashboard content -->
            <div class="kyc-banner mb-8"></div>

            <!-- User Information Section -->
            <div id="userInfo"></div>

            <!-- Policies Section -->
            <div id="policiesSection"></div>

            <!-- Quick Actions -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-8">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Quick Actions</h3>
                    <div class="space-y-4">
                        <a href="life-insurance.html" class="block w-full text-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">
                            Buy New Policy
                        </a>
                        <button onclick="viewAllPolicies()" class="block w-full text-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                            View All Policies
                        </button>
                        <button onclick="downloadKYC()" class="block w-full text-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                            Download KYC Details
                        </button>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="bg-white rounded-lg shadow-md p-6 md:col-span-2">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Recent Activity</h3>
                    <div class="space-y-4">
                        <div class="flex items-center justify-between py-3 border-b">
                            <div>
                                <p class="text-sm font-medium text-gray-900">KYC Verification Completed</p>
                                <p class="text-sm text-gray-500" id="kycVerificationDate"></p>
                            </div>
                            <span class="px-2 py-1 text-xs text-green-800 bg-green-100 rounded-full">Completed</span>
                        </div>
                        <div id="recentActivities">
                            <!-- Recent activities will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Add script reference -->
    <script src="js/kyc.js"></script>

    <!-- Add Claim Modal -->
    <div id="claimModal" class="claim-modal">
        <div class="claim-modal-content">
            <div class="modal-header">
                <h2>Submit Insurance Claim</h2>
                <button class="close-btn" onclick="closeClaimModal()">Ã—</button>
            </div>
            <form id="claimForm" class="claim-form">
                <div class="form-group">
                    <label for="claimType">Claim Type</label>
                    <select id="claimType" required>
                        <option value="">Select Claim Type</option>
                        <option value="death">Death Claim</option>
                        <option value="medical">Medical Claim</option>
                        <option value="accident">Accidental Death</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="claimAmount">Claim Amount (ETH)</label>
                    <input type="number" id="claimAmount" name="claimAmount" step="0.000001" required>
                </div>
                <div class="form-group">
                    <label for="walletAddress">Your Wallet Address</label>
                    <input type="text" id="walletAddress" name="walletAddress" 
                        pattern="0x[a-fA-F0-9]{40}" 
                        placeholder="0x..." 
                        required>
                    <small class="text-gray-500">Enter your Ethereum wallet address where you want to receive the claim amount</small>
                </div>
                <div class="form-group">
                    <label for="description">Description</label>
                    <textarea id="description" name="description" required></textarea>
                </div>
                <div class="form-group">
                    <label>Supporting Documents</label>
                    <div class="file-upload" onclick="document.getElementById('fileInput').click()">
                        <input type="file" id="fileInput" multiple style="display: none" onchange="handleFileSelect(event)">
                        <p>Click to upload or drag and drop files here</p>
                        <p class="text-sm text-gray-500">Supported formats: PDF, JPG, PNG (Max 5MB each)</p>
                    </div>
                    <div id="fileList" class="file-list"></div>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Submit Claim</button>
                    <button type="button" class="btn btn-secondary" onclick="closeClaimModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</body>
</html> 